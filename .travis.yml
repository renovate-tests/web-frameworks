# Exit build if no modification found
before_install: bash .ci/has_to_run.sh || travis_terminate 0

# Use xenial since wrk is not available on bionic
dist: xenial

services:
  - docker # Use docker to containerize frameworks
  - postgresql # Use postgresql to store data

# This tool is written in crystal
language: crystal

# We need also ruby for beta features
addons:
  apt:
    update: true
    packages:
      - ruby
      - jq
      - wrk

env:
  global:
    - DATABASE_URL=postgresql://postgres@localhost/benchmark
    - COLLECT=off
    - CLEAN=off
    - SLEEP=5
  jobs:
      - FRAMEWORK=swift.kitura
      - FRAMEWORK=swift.kitura-nio
      - FRAMEWORK=swift.vapor-framework
      - FRAMEWORK=swift.swifter-framework
      - FRAMEWORK=swift.perfect
      - FRAMEWORK=javascript.sifrr
      - FRAMEWORK=javascript.restify
      - FRAMEWORK=javascript.hapi
      - FRAMEWORK=javascript.moleculer
      - FRAMEWORK=javascript.koa
      - FRAMEWORK=javascript.turbo-polka
      - FRAMEWORK=javascript.sails
      - FRAMEWORK=javascript.nestjs-fastify
      - FRAMEWORK=javascript.rayo
      - FRAMEWORK=javascript.polkadot
      - FRAMEWORK=javascript.nestjs-express
      - FRAMEWORK=javascript.0http
      - FRAMEWORK=javascript.foxify
      - FRAMEWORK=javascript.nanoexpress
      - FRAMEWORK=javascript.fastify
      - FRAMEWORK=javascript.nanoexpress-pro
      - FRAMEWORK=javascript.polka
      - FRAMEWORK=javascript.feathersjs
      - FRAMEWORK=javascript.iotjs-express
      - FRAMEWORK=javascript.muneem
      - FRAMEWORK=javascript.express
      - FRAMEWORK=javascript.restana
      - FRAMEWORK=fsharp.suave
      - FRAMEWORK=perl.dancer2
      - FRAMEWORK=java.jooby
      - FRAMEWORK=java.javalin
      - FRAMEWORK=java.spring-boot
      - FRAMEWORK=java.act
      - FRAMEWORK=java.spring-framework
      - FRAMEWORK=java.rapidoid
      - FRAMEWORK=java.micronaut
      - FRAMEWORK=kotlin.ktor
      - FRAMEWORK=kotlin.kooby
      - FRAMEWORK=pony.jennet
      - FRAMEWORK=python.nameko
      - FRAMEWORK=python.cyclone
      - FRAMEWORK=python.tornado
      - FRAMEWORK=python.masonite
      - FRAMEWORK=python.bottle
      - FRAMEWORK=python.sanic
      - FRAMEWORK=python.klein
      - FRAMEWORK=python.django
      - FRAMEWORK=python.fastapi
      - FRAMEWORK=python.flask
      - FRAMEWORK=python.molten
      - FRAMEWORK=python.falcon
      - FRAMEWORK=python.aiohttp
      - FRAMEWORK=python.clastic
      - FRAMEWORK=python.starlette
      - FRAMEWORK=python.blacksheep
      - FRAMEWORK=python.pyramid
      - FRAMEWORK=python.hug
      - FRAMEWORK=python.emmett
      - FRAMEWORK=python.quart
      - FRAMEWORK=python.asgineer
      - FRAMEWORK=python.responder
      - FRAMEWORK=python.apidaora
      - FRAMEWORK=python.cherrypy
      - FRAMEWORK=php.workerman
      - FRAMEWORK=php.yii
      - FRAMEWORK=php.hamlet
      - FRAMEWORK=php.spiral
      - FRAMEWORK=php.symfony
      - FRAMEWORK=php.basicphp
      - FRAMEWORK=php.mezzio
      - FRAMEWORK=php.sw-fw-less
      - FRAMEWORK=php.ubiquity
      - FRAMEWORK=php.one
      - FRAMEWORK=php.chubbyphp
      - FRAMEWORK=php.phalcon
      - FRAMEWORK=php.ice
      - FRAMEWORK=php.one-fpm
      - FRAMEWORK=php.laminas
      - FRAMEWORK=php.hyperf
      - FRAMEWORK=php.slim
      - FRAMEWORK=php.simps
      - FRAMEWORK=php.lumen
      - FRAMEWORK=php.laravel
      - FRAMEWORK=php.swoft
      - FRAMEWORK=php.imi
      - FRAMEWORK=dart.aqueduct
      - FRAMEWORK=csharp.aspnetcore
      - FRAMEWORK=go.beego
      - FRAMEWORK=go.httprouter
      - FRAMEWORK=go.gf
      - FRAMEWORK=go.fiber
      - FRAMEWORK=go.gorouter-fasthttp
      - FRAMEWORK=go.rte
      - FRAMEWORK=go.violetear
      - FRAMEWORK=go.gorilla-mux
      - FRAMEWORK=go.atreugo
      - FRAMEWORK=go.goroute
      - FRAMEWORK=go.fasthttp
      - FRAMEWORK=go.kami
      - FRAMEWORK=go.gorouter
      - FRAMEWORK=go.air
      - FRAMEWORK=go.mars
      - FRAMEWORK=go.chi
      - FRAMEWORK=go.webgo
      - FRAMEWORK=go.aero
      - FRAMEWORK=go.echo
      - FRAMEWORK=go.tango
      - FRAMEWORK=go.gin
      - FRAMEWORK=go.router
      - FRAMEWORK=go.fasthttprouter
      - FRAMEWORK=go.gramework
      - FRAMEWORK=scala.http4s
      - FRAMEWORK=scala.akkahttp
      - FRAMEWORK=ruby.cuba
      - FRAMEWORK=ruby.hanami-api
      - FRAMEWORK=ruby.hanami
      - FRAMEWORK=ruby.rack-app
      - FRAMEWORK=ruby.camping
      - FRAMEWORK=ruby.sinatra
      - FRAMEWORK=ruby.syro
      - FRAMEWORK=ruby.rack-routing
      - FRAMEWORK=ruby.roda
      - FRAMEWORK=ruby.agoo
      - FRAMEWORK=ruby.flame
      - FRAMEWORK=ruby.grape
      - FRAMEWORK=ruby.rails
      - FRAMEWORK=crystal.toro
      - FRAMEWORK=crystal.orion
      - FRAMEWORK=crystal.lucky
      - FRAMEWORK=crystal.onyx
      - FRAMEWORK=crystal.shivneri
      - FRAMEWORK=crystal.ricr
      - FRAMEWORK=crystal.grip
      - FRAMEWORK=crystal.athena
      - FRAMEWORK=crystal.amber
      - FRAMEWORK=crystal.router.cr
      - FRAMEWORK=crystal.spider-gazelle
      - FRAMEWORK=crystal.kemal
      - FRAMEWORK=cpp.drogon
      - FRAMEWORK=cpp.evhtp
      - FRAMEWORK=julia.merly
      - FRAMEWORK=rust.gotham
      - FRAMEWORK=rust.iron
      - FRAMEWORK=rust.actix
      - FRAMEWORK=rust.nickel
      - FRAMEWORK=elixir.plug
      - FRAMEWORK=elixir.cowboy
      - FRAMEWORK=elixir.phoenix
      - FRAMEWORK=elixir.cowboy_stream
      - FRAMEWORK=clojure.coast
      - FRAMEWORK=c.agoo-c
      - FRAMEWORK=c.kore
      - FRAMEWORK=nim.jester
      - FRAMEWORK=nim.httpbeast

before_script:
  - psql -c 'CREATE DATABASE benchmark;' -U postgres;
  - psql -U postgres -d benchmark < .ci/dump.sql
  - bundle install
  - bundle exec rake config

script:
  - shards install
  - shards build
  - travis_retry bin/neph ${FRAMEWORK} --mode=CI
  - bundle exec rspec .spec

# Push on docker registry if tests are OK
# This does not work on forks
after_success: if [[ ${CURRENT_BRANCH} == "master" && !-z ${TRAVIS_PULL_REQUEST_SLUG} ]] ; then bash .ci/docker_release.sh ; fi

notifications:
  email: false
